/* Tiny tinycomments plugin
*
* Copyright 2010-2018 Tiny Technologies Inc. All rights reserved.
*
* Version: 2.0.1-76
*/
!function(f){"use strict";var n,e,t,o,r,h,i,g=function(n){var e=n,t=function(){return e};return{get:t,set:function(n){e=n},clone:function(){return g(t())}}},a=function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e]},p=function(t,o){return function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return t(o.apply(null,n))}},_=function(n){return function(){return n}},u=function(n){return n},c=_(!1),s=_(!0),d=c,l=s,m=function(){return v},v=(o={fold:function(n,e){return n()},is:d,isSome:d,isNone:l,getOr:t=function(n){return n},getOrThunk:e=function(n){return n()},getOrDie:function(n){throw new Error(n||"error: getOrDie called on none.")},getOrNull:function(){return null},getOrUndefined:function(){},or:t,orThunk:e,map:m,ap:m,each:function(){},bind:m,flatten:m,exists:d,forall:l,filter:m,equals:n=function(n){return n.isNone()},equals_:n,toArray:function(){return[]},toString:_("none()")},Object.freeze&&Object.freeze(o),o),y=function(t){var n=function(){return t},e=function(){return r},o=function(n){return n(t)},r={fold:function(n,e){return e(t)},is:function(n){return t===n},isSome:l,isNone:d,getOr:n,getOrThunk:n,getOrDie:n,getOrNull:n,getOrUndefined:n,or:e,orThunk:e,map:function(n){return y(n(t))},ap:function(n){return n.fold(m,function(n){return y(n(t))})},each:function(n){n(t)},bind:o,flatten:n,exists:o,forall:o,filter:function(n){return n(t)?r:v},equals:function(n){return n.is(t)},equals_:function(n,e){return n.fold(d,function(n){return e(t,n)})},toArray:function(){return[t]},toString:function(){return"some("+t+")"}};return r},w={some:y,none:m,from:function(n){return null==n?v:y(n)}},b=function(n){return parseInt(n,10)},O=function(n,e,t){return{major:n,minor:e,patch:t}},C=function(n){var e=/([0-9]+)\.([0-9]+)\.([0-9]+)(?:(\-.+)?)/.exec(n);return e?O(b(e[1]),b(e[2]),b(e[3])):O(0,0,0)},E=function(n,e){var t=n-e;return 0===t?0:0<t?1:-1},D=function(n,e){return-1===function(n,e){var t=E(n.major,e.major);if(0!==t)return t;var o=E(n.minor,e.minor);if(0!==o)return o;var r=E(n.patch,e.patch);return 0!==r?r:0}((t=n)?C([(o=t).majorVersion,o.minorVersion].join(".").split(".").slice(0,3).join(".")):null,C(e));var t,o},S=0,T=function(n){var e=(new Date).getTime();return n+"_"+Math.floor(1e9*Math.random())+ ++S+String(e)},x=function(e){return function(n){return function(n){if(null===n)return"null";var e=typeof n;return"object"===e&&Array.prototype.isPrototypeOf(n)?"array":"object"===e&&String.prototype.isPrototypeOf(n)?"string":e}(n)===e}},A=x("string"),N=x("object"),k=x("boolean"),M=x("function"),R=x("number"),j=function(n,e){for(var t=n.length,o=new Array(t),r=0;r<t;r++){var i=n[r];o[r]=e(i,r,n)}return o},L=function(n,e){for(var t=0,o=n.length;t<o;t++)e(n[t],t,n)},U=function(n,e){for(var t=[],o=0,r=n.length;o<r;o++){var i=n[o];e(i,o,n)&&t.push(i)}return t},I=function(n,e){for(var t=0,o=n.length;t<o;t++){var r=n[t];if(e(r,t,n))return w.some(r)}return w.none()},B=(Array.prototype.slice,M(Array.from)&&Array.from,Object.keys),P=Object.hasOwnProperty,F=function(n,e){for(var t=B(n),o=0,r=t.length;o<r;o++){var i=t[o];e(n[i],i,n)}},H=function(o,r){var i={};return F(o,function(n,e){var t=r(n,e,o);i[t.k]=t.v}),i},V=function(n,e){return P.call(n,e)},q=(f.Node.ATTRIBUTE_NODE,f.Node.CDATA_SECTION_NODE,f.Node.COMMENT_NODE),Y=f.Node.DOCUMENT_NODE,W=(f.Node.DOCUMENT_TYPE_NODE,f.Node.DOCUMENT_FRAGMENT_NODE,f.Node.ELEMENT_NODE),X=(f.Node.TEXT_NODE,f.Node.PROCESSING_INSTRUCTION_NODE,f.Node.ENTITY_REFERENCE_NODE,f.Node.ENTITY_NODE,f.Node.NOTATION_NODE,function(n,e,t){if(!(A(t)||k(t)||R(t)))throw f.console.error("Invalid call to Attr.set. Key ",e,":: Value ",t,":: Element ",n),new Error("Attribute value was not simple");n.setAttribute(e,t+"")}),z=function(n,e,t){X(n.dom(),e,t)},G=function(n,e){n.dom().removeAttribute(e)},J=function(t){var o,r=!1;return function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return r||(r=!0,o=t.apply(null,n)),o}},$=function(n){if(null==n)throw new Error("Node cannot be null or undefined");return{dom:_(n)}},K={fromHtml:function(n,e){var t=(e||f.document).createElement("div");if(t.innerHTML=n,!t.hasChildNodes()||1<t.childNodes.length)throw f.console.error("HTML does not have a single root node",n),new Error("HTML must have a single root node");return $(t.childNodes[0])},fromTag:function(n,e){var t=(e||f.document).createElement(n);return $(t)},fromText:function(n,e){var t=(e||f.document).createTextNode(n);return $(t)},fromDom:$,fromPoint:function(n,e,t){var o=n.dom();return w.from(o.elementFromPoint(e,t)).map($)}},Q=J(function(){return Z(K.fromDom(f.document))}),Z=function(n){var e=n.dom().body;if(null==e)throw new Error("Body is not available yet");return K.fromDom(e)},nn=function(n,e){return-1!==n.indexOf(e)},en=function(n,e){var t=n.dom();F(e,function(n,e){!function(n,e,t){if(!A(t))throw f.console.error("Invalid call to CSS.set. Property ",e,":: Value ",t,":: Element ",n),new Error("CSS value must be a string: "+t);void 0!==n.style&&n.style.setProperty(e,t)}(t,e,n)})},tn=void 0!==f.window?f.window:Function("return this;")(),on=function(n,e){return function(n,e){for(var t=null!=e?e:tn,o=0;o<n.length&&null!=t;++o)t=t[n[o]];return t}(n.split("."),e)},rn={getOrDie:function(n,e){var t=on(n,e);if(null==t)throw n+" not available on this browser";return t}},un=function(){return cn(0,0)},cn=function(n,e){return{major:n,minor:e}},an={nu:cn,detect:function(n,e){var t=String(e).toLowerCase();return 0===n.length?un():function(n,e){var t=function(n,e){for(var t=0;t<n.length;t++){var o=n[t];if(o.test(e))return o}}(n,e);if(!t)return{major:0,minor:0};var o=function(n){return Number(e.replace(t,"$"+n))};return cn(o(1),o(2))}(n,t)},unknown:un},sn="Firefox",fn=function(n,e){return function(){return e===n}},dn=function(n){var e=n.current;return{current:e,version:n.version,isEdge:fn("Edge",e),isChrome:fn("Chrome",e),isIE:fn("IE",e),isOpera:fn("Opera",e),isFirefox:fn(sn,e),isSafari:fn("Safari",e)}},ln={unknown:function(){return dn({current:void 0,version:an.unknown()})},nu:dn,edge:_("Edge"),chrome:_("Chrome"),ie:_("IE"),opera:_("Opera"),firefox:_(sn),safari:_("Safari")},mn="Windows",vn="Android",hn="Solaris",gn="FreeBSD",pn=function(n,e){return function(){return e===n}},_n=function(n){var e=n.current;return{current:e,version:n.version,isWindows:pn(mn,e),isiOS:pn("iOS",e),isAndroid:pn(vn,e),isOSX:pn("OSX",e),isLinux:pn("Linux",e),isSolaris:pn(hn,e),isFreeBSD:pn(gn,e)}},yn={unknown:function(){return _n({current:void 0,version:an.unknown()})},nu:_n,windows:_(mn),ios:_("iOS"),android:_(vn),linux:_("Linux"),osx:_("OSX"),solaris:_(hn),freebsd:_(gn)},wn=function(n,e){var t=String(e).toLowerCase();return I(n,function(n){return n.search(t)})},bn=function(n,t){return wn(n,t).map(function(n){var e=an.detect(n.versionRegexes,t);return{current:n.name,version:e}})},On=function(n,t){return wn(n,t).map(function(n){var e=an.detect(n.versionRegexes,t);return{current:n.name,version:e}})},Cn=/.*?version\/\ ?([0-9]+)\.([0-9]+).*/,En=function(e){return function(n){return nn(n,e)}},Dn=[{name:"Edge",versionRegexes:[/.*?edge\/ ?([0-9]+)\.([0-9]+)$/],search:function(n){return nn(n,"edge/")&&nn(n,"chrome")&&nn(n,"safari")&&nn(n,"applewebkit")}},{name:"Chrome",versionRegexes:[/.*?chrome\/([0-9]+)\.([0-9]+).*/,Cn],search:function(n){return nn(n,"chrome")&&!nn(n,"chromeframe")}},{name:"IE",versionRegexes:[/.*?msie\ ?([0-9]+)\.([0-9]+).*/,/.*?rv:([0-9]+)\.([0-9]+).*/],search:function(n){return nn(n,"msie")||nn(n,"trident")}},{name:"Opera",versionRegexes:[Cn,/.*?opera\/([0-9]+)\.([0-9]+).*/],search:En("opera")},{name:"Firefox",versionRegexes:[/.*?firefox\/\ ?([0-9]+)\.([0-9]+).*/],search:En("firefox")},{name:"Safari",versionRegexes:[Cn,/.*?cpu os ([0-9]+)_([0-9]+).*/],search:function(n){return(nn(n,"safari")||nn(n,"mobile/"))&&nn(n,"applewebkit")}}],Sn=[{name:"Windows",search:En("win"),versionRegexes:[/.*?windows\ nt\ ?([0-9]+)\.([0-9]+).*/]},{name:"iOS",search:function(n){return nn(n,"iphone")||nn(n,"ipad")},versionRegexes:[/.*?version\/\ ?([0-9]+)\.([0-9]+).*/,/.*cpu os ([0-9]+)_([0-9]+).*/,/.*cpu iphone os ([0-9]+)_([0-9]+).*/]},{name:"Android",search:En("android"),versionRegexes:[/.*?android\ ?([0-9]+)\.([0-9]+).*/]},{name:"OSX",search:En("os x"),versionRegexes:[/.*?os\ x\ ?([0-9]+)_([0-9]+).*/]},{name:"Linux",search:En("linux"),versionRegexes:[]},{name:"Solaris",search:En("sunos"),versionRegexes:[]},{name:"FreeBSD",search:En("freebsd"),versionRegexes:[]}],Tn={browsers:_(Dn),oses:_(Sn)},xn=function(n){var e,t,o,r,i,u,c,a,s,f,d,l=Tn.browsers(),m=Tn.oses(),v=bn(l,n).fold(ln.unknown,ln.nu),h=On(m,n).fold(yn.unknown,yn.nu);return{browser:v,os:h,deviceType:(t=v,o=n,r=(e=h).isiOS()&&!0===/ipad/i.test(o),i=e.isiOS()&&!r,u=e.isAndroid()&&3===e.version.major,c=e.isAndroid()&&4===e.version.major,a=r||u||c&&!0===/mobile/i.test(o),s=e.isiOS()||e.isAndroid(),f=s&&!a,d=t.isSafari()&&e.isiOS()&&!1===/safari/i.test(o),{isiPad:_(r),isiPhone:_(i),isTablet:_(a),isPhone:_(f),isTouch:_(s),isAndroid:e.isAndroid,isiOS:e.isiOS,isWebView:_(d)})}},An={detect:J(function(){var n=f.navigator.userAgent;return xn(n)})},Nn=W,kn=Y,Mn=function(n){return n.nodeType!==Nn&&n.nodeType!==kn||0===n.childElementCount},Rn=(An.detect().browser.isIE(),function(n){return K.fromDom(n.dom().ownerDocument)}),jn=function(n){var e=n.dom();return j(e.childNodes,K.fromDom)},Ln=(function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e]}("element","offset"),function(n,e){n.dom().appendChild(e.dom())}),Un=function(n){n.dom().textContent="",L(jn(n),function(n){In(n)})},In=function(n){var e=n.dom();null!==e.parentNode&&e.parentNode.removeChild(e)},Bn=function(n){var r,e=jn(n);0<e.length&&(r=n,L(e,function(n){var e,t,o;(function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e]})("element","offset"),t=n,(o=(e=r).dom(),w.from(o.parentNode).map(K.fromDom)).each(function(n){n.dom().insertBefore(t.dom(),e.dom())})})),In(n)},Pn=function(n,e){var t,o,r,i=Rn(n).dom(),u=K.fromDom(i.createDocumentFragment()),c=(t=e,(o=(i||f.document).createElement("div")).innerHTML=t,jn(K.fromDom(o)));r=u,L(c,function(n){Ln(r,n)}),Un(n),Ln(n,u)},Fn=function(n,e){return t=e,r=void 0===(o=n)?f.document:o.dom(),Mn(r)?w.none():w.from(r.querySelector(t)).map(K.fromDom);var t,o,r},Hn=An.detect().os.isOSX()?"âŒ˜":"Ctrl",Vn=(r=u,H({tc_menu_name:"TinyComments",tc_announce_sidebar_available:"Comment. Sidebar available. Press "+Hn+" + Alt + M to switch to sidebar",tc_items_addcomment:"Add comment",tc_items_showcomments:"Show comments",tc_items_deleteall:"Delete all conversations",tc_edit_buttons_save:"Save",tc_edit_buttons_cancel:"Cancel",tc_reply_buttons_save:"Save",tc_reply_buttons_clear:"Clear",tc_reply_placeholders:"Say something ...",tc_kebab_deleteconversation:"Delete conversation",tc_kebab_delete:"Delete",tc_kebab_edit:"Edit",tc_edit_problem_comment:"An error occurred editing this comment. See the Console for details.",tc_edit_unauthorised_comment:"You are not allowed to edit this comment",tc_delete_buttons_cancel:"Cancel",tc_delete_buttons_proceed:"Delete",tc_create_problem:"An error occurred while creating a comment. See the Console for details",tc_reply_problem:"An error occurred while replying to a comment. See the Console for details",tc_delete_prompts_conversation:"Delete this conversation?",tc_delete_prompts_conversation_detail_sing:"1 comment will be deleted. You can't undo this action.",tc_delete_prompts_conversation_detail_pl:"{0} comments will be deleted. You can't undo this action.",tc_delete_prompts_all:"Delete all conversations in the content? This cannot be undone",tc_delete_prompts_comment:"Are you sure you want to delete this comment?",tc_delete_problem_all:"An error occurred deleting all the conversations. See the Console for details.",tc_delete_problem_conversation:"An error occurred deleting the conversation. See the Console for details.",tc_delete_problem_comment:"An error occurred deleting the comment. See the Console for details.",tc_delete_unauthorised_all:"You are not allowed to delete all the conversations",tc_delete_unauthorised_conversation:"You are not allowed to delete this conversation",tc_delete_unauthorised_comment:"You are not allowed to delete this comment",tc_date_less_than_a_minute_ago:"a moment ago",tc_date_1_minute_ago:"1 minute ago",tc_date_x_minutes_ago:"{0} minutes ago",tc_date_1_hour_ago:"1 hour ago",tc_date_x_hours_ago:"{0} hours ago",tc_date_1_day_ago:"1 day ago",tc_date_x_days_ago:"{0} days ago",tc_date_1_week_ago:"1 week ago",tc_date_x_weeks_ago:"{0} weeks ago",tc_date_1_month_ago:"1 month ago",tc_date_x_months_ago:"{0} months ago",tc_date_1_year_ago:"1 year ago",tc_date_x_years_ago:"{0} years ago",tc_date_comment_edited:" (edited)",tc_comment_buttons_showmore:"SHOW MORE",tc_comment_buttons_showless:"SHOW LESS"},function(n,e,t){return{k:e,v:r(n,e,t)}})),qn=T("aria-comment-description"),Yn=function(n){var e,t,o=Fn(Q(),"#"+qn).getOrThunk(function(){var n=K.fromTag("span");return z(n,"id",qn),z(n,"aria-live","polite"),z(n,"aria-atomic","true"),z(n,"role","alert"),en(n,{position:"absolute",left:"-10000px",top:"-1000px"}),Ln(Q(),n),n});return e=n,t=o,{onComment:function(){Pn(t,e.translate(Vn.tc_announce_sidebar_available))},notOnComment:function(){Pn(t,"")},getMarker:function(){return t}}},Wn=function(o,r){return function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];var t=o.console;t&&r in t&&t[r].apply(t,arguments)}},Xn={log:Wn(f.window,"log"),error:Wn(f.window,"error"),warn:Wn(f.window,"warm")},zn=function(n){var t=w.none(),e=[],o=function(n){r()?u(n):e.push(n)},r=function(){return t.isSome()},i=function(n){L(n,u)},u=function(e){t.each(function(n){f.setTimeout(function(){e(n)},0)})};return n(function(n){t=w.some(n),i(e),e=[]}),{get:o,map:function(t){return zn(function(e){o(function(n){e(t(n))})})},isReady:r}},Gn={nu:zn,pure:function(e){return zn(function(n){n(e)})}},Jn=function(e){var n=function(n){var o;e((o=n,function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];var t=this;f.setTimeout(function(){o.apply(t,n)},0)}))},t=function(){return Gn.nu(n)};return{map:function(o){return Jn(function(t){n(function(n){var e=o(n);t(e)})})},bind:function(t){return Jn(function(e){n(function(n){t(n).get(e)})})},anonBind:function(t){return Jn(function(e){n(function(n){t.get(e)})})},toLazy:t,toCached:function(){var e=null;return Jn(function(n){null===e&&(e=t()),e.get(n)})},get:n}},$n={nu:Jn,pure:function(e){return Jn(function(n){n(e)})}},Kn=function(u,n){return n(function(o){var r=[],i=0;0===u.length?o([]):L(u,function(n,e){var t;n.get((t=e,function(n){r[t]=n,++i>=u.length&&o(r)}))})})},Qn=function(n){return Kn(n,$n.nu)},Zn=function(m,v){return function(n){if(m(n)){var e,t,o,r,i,u,c,a=K.fromDom(n.target),s=function(){n.stopPropagation()},f=function(){n.preventDefault()},d=p(f,s),l=(e=a,t=n.clientX,o=n.clientY,r=s,i=f,u=d,c=n,{target:_(e),x:_(t),y:_(o),stop:r,prevent:i,kill:u,raw:_(c)});v(l)}}},ne=function(n,e,t,o){return r=n,i=e,u=!1,c=Zn(t,o),r.dom().addEventListener(i,c,u),{unbind:function(o){for(var r=[],n=1;n<arguments.length;n++)r[n-1]=arguments[n];return function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];var t=r.concat(n);return o.apply(null,t)}}(ee,r,i,c,u)};var r,i,u,c},ee=function(n,e,t,o){n.dom().removeEventListener(e,t,o)},te=_(!0),oe=function(n,e,t){return ne(n,e,te,t)},re=g(w.none()),ie="_tinycomments_sidebar",ue=function(r){return $n.nu(function(n){var e,t,o=K.fromTag("link");e={rel:"stylesheet",href:r},t=o.dom(),F(e,function(n,e){X(t,e,n)}),oe(o,"load",function(){n()}),Ln(K.fromDom(f.document.head),o)})},ce=function(e){return re.get().getOrThunk(function(){var n=$n.nu(function(n){tinymce[ie]=n,Qn(j(e,function(n){return("js"===n.type?function(t){return $n.nu(function(n){var e=K.fromTag("script");z(e,"src",t),oe(e,"load",function(){n()}),Ln(Q(),e)})}:ue)(n.filename)})).get(a)}).toLazy();return re.set(w.some(n)),n})};(i=h||(h={}))[i.Modern=0]="Modern",i[i.Silver=1]="Silver";var ae,se,fe,de,le,me,ve=function(n,e){return t=e,r=void 0===(o=n)?f.document:o.dom(),Mn(r)?[]:j(r.querySelectorAll(t),K.fromDom);var t,o,r},he=_("tox-comment"),ge=_("data-mce-annotation-uid"),pe=_("data-mce-annotation"),_e=_("tinycomments"),ye=_("tox-comments-visible"),we=function(n,e,t,o){return Pn(n,e),L(ve(n,t),o),n.dom().innerHTML},be=function(o,r,i){for(var u=K.fromTag("div"),n=function(t){o[t].content=we(u,o[t].content,r,i),L(o[t].fragments||[],function(n,e){o[t].fragments[e]=we(u,o[t].fragments[e],r,i)})},e=0;e<o.length;e++)n(e)},Oe=function(n,e){var t;be(n,(t=e,"["+ge()+'="'+t+'"]'),Bn)},Ce=function(n){be(n,"["+pe()+'="'+_e()+'"]',Bn)},Ee="tc-open-comment",De="tc-try-delete-all-conversations",Se="tc-delete-conversation-at-cursor",Te=function(o,r,t){var i=_e();o.addCommand(De,function(n,e){o.windowManager.confirm(Vn.tc_delete_prompts_all,function(n){if(n)return t.deleteAllConversations({}).get(function(n){n.fold(function(n){return r.showError(Vn.tc_delete_problem_all,n)},function(n){if(n.canDelete){var e=o.selection.getBookmark();o.focus();var t=o.annotator.getAll(i);F(t,function(n,e){var t;(t=n,0===t.length?w.none():w.some(t[0])).each(function(n){o.selection.select(n),o.annotator.remove(i)})}),o.selection.moveToBookmark(e),Ce(o.undoManager.data),r.refreshSidebar(w.none(),2),o.focus()}else r.showError(Vn.tc_delete_unauthorised_all)})})})})},xe=function(n,e,u,c){n.on("init",function(){var o,r,t,i;o=e,r=c,n.addCommand(Ee,function(n,e){var t=r.get();o.refreshSidebar(t,e.grabFocus?1:0)}),i=e,(t=n).addCommand(Se,function(n,e){t.undoManager.transact(function(){return t.annotator.remove(_e())}),Oe(t.undoManager.data,e.conversationUid),i.refreshSidebar(w.none(),2),t.focus()}),Te(n,e,u)})},Ae=function(n,e){return n.execCommand(Ee,null,{grabFocus:e})},Ne=function(n){n.execCommand(De,null,{})},ke=function(n,e){n.execCommand("ToggleSidebar",null,e)},Me=function(){return(Me=Object.assign||function(n){for(var e,t=1,o=arguments.length;t<o;t++)for(var r in e=arguments[t])Object.prototype.hasOwnProperty.call(e,r)&&(n[r]=e[r]);return n}).apply(this,arguments)},Re=function(t){return{is:function(n){return t===n},isValue:s,isError:c,getOr:_(t),getOrThunk:_(t),getOrDie:_(t),or:function(n){return Re(t)},orThunk:function(n){return Re(t)},fold:function(n,e){return e(t)},map:function(n){return Re(n(t))},mapError:function(n){return Re(t)},each:function(n){n(t)},bind:function(n){return n(t)},exists:function(n){return n(t)},forall:function(n){return n(t)},toOption:function(){return w.some(t)}}},je=function(t){return{is:c,isValue:c,isError:s,getOr:u,getOrThunk:function(n){return n()},getOrDie:function(){return n=String(t),function(){throw new Error(n)}();var n},or:function(n){return n},orThunk:function(n){return n()},fold:function(n,e){return n(t)},map:function(n){return je(t)},mapError:function(n){return je(n(t))},each:a,bind:function(n){return je(t)},exists:c,forall:s,toOption:w.none}},Le={value:Re,error:je},Ue=function(i){return Me({},i,{toCached:function(){return Ue(i.toCached())},bindFuture:function(e){return Ue(i.bind(function(n){return n.fold(function(n){return $n.pure(Le.error(n))},function(n){return e(n)})}))},bindResult:function(e){return Ue(i.map(function(n){return n.bind(e)}))},mapResult:function(e){return Ue(i.map(function(n){return n.map(e)}))},mapError:function(e){return Ue(i.map(function(n){return n.mapError(e)}))},foldResult:function(e,t){return i.map(function(n){return n.fold(e,t)})},withTimeout:function(n,r){return Ue($n.nu(function(e){var t=!1,o=f.setTimeout(function(){t=!0,e(Le.error(r()))},n);i.get(function(n){t||(f.clearTimeout(o),e(n))})}))}})},Ie=function(n){return Ue($n.nu(n))},Be=function(n){return Ue($n.pure(Le.value(n)))},Pe=Ie,Fe=Be,He=function(n){return Ue($n.pure(Le.error(n)))},Ve=function(t){return function(n){return Pe(function(e){return t(n,function(n){e(Le.value(n))},function(n){e(Le.error(n))})})}},qe=function(t){return function(n){var e=n.settings[t];if(M(e))return e;throw new Error(t+" has not been implemented.")}},Ye=function(e,t){return function(n){return V(n.settings,e)?n.settings[e]:t()}},We=function(t,o){return function(n){var e=Ye(t,function(){return o(Ze(n))})(n);return Ve(e)}},Xe=qe("tinycomments_create"),ze=qe("tinycomments_reply"),Ge=qe("tinycomments_delete"),Je=qe("tinycomments_delete_all"),$e=qe("tinycomments_delete_comment"),Ke=qe("tinycomments_edit_comment"),Qe=qe("tinycomments_lookup"),Ze=Ye("tinycomments_author",function(){return"Anon"}),nt=We("tinycomments_can_delete",function(o){return function(n,e,t){e({canDelete:0<n.comments.length&&n.comments[0].author===o&&!0})}}),et=We("tinycomments_can_delete_comment",function(o){return function(n,e,t){e({canDelete:n.comment.author===o&&!0})}}),tt=We("tinycomments_can_edit_comment",function(o){return function(n,e,t){e({canEdit:n.comment.author===o&&!0})}}),ot=Ye("tinycomments_mode",function(){return"callback"}),rt=function(n){var e=Xe(n),t=ze(n),o=Qe(n),r=Ge(n),i=Je(n),u=$e(n),c=Ke(n);return{create:Ve(e),reply:Ve(t),lookup:Ve(o),deleteConversation:Ve(r),deleteAllConversations:Ve(i),editComment:Ve(c),deleteComment:Ve(u),lifecycleHooks:{onSetContent:a,onGetContent:w.none}}},it=Object.prototype.hasOwnProperty,ut=(ae=function(n,e){return N(n)&&N(e)?ut(n,e):e},function(){for(var n=new Array(arguments.length),e=0;e<n.length;e++)n[e]=arguments[e];if(0===n.length)throw new Error("Can't merge zero objects");for(var t={},o=0;o<n.length;o++){var r=n[o];for(var i in r)it.call(r,i)&&(t[i]=ae(t[i],r[i]))}return t}),ct=function(e){return function(n){return{uid:n.uid,comments:U(n.comments,function(n){return n.uid!==e})}}},at=function(e,t,o){return function(n){return{uid:n.uid,comments:j(n.comments,function(n){return n.uid===e?Me({},n,{content:t,modifiedAt:o}):n})}}},st=function(){return rn.getOrDie("JSON")},ft=function(n){return st().parse(n)},dt=(se=function(n){return n.dom().nodeType===q||"#comment"===n.dom().nodeName.toLowerCase()},fe="comment",de=function(n){return se(n)?w.from(n.dom().nodeValue):w.none()},le=An.detect().browser,{get:function(n){if(!se(n))throw new Error("Can only get "+fe+" value of a "+fe+" node");return me(n).getOr("")},getOption:me=le.isIE()&&10===le.version.major?function(n){try{return de(n)}catch(n){return w.none()}}:de,set:function(n,e){if(!se(n))throw new Error("Can only set raw "+fe+" value of a "+fe+" node");n.dom().nodeValue=e}});function lt(n,e){return vt(f.document.createElement("canvas"),n,e)}function mt(n){return n.getContext("2d")}function vt(n,e,t){return n.width=e,n.height=t,n}var ht={create:lt,clone:function(n){var e;return mt(e=lt(n.width,n.height)).drawImage(n,0,0),e},resize:vt,get2dContext:mt,get3dContext:function(n){var e=null;try{e=n.getContext("webgl")||n.getContext("experimental-webgl")}catch(n){}return e||(e=null),e}},gt={getWidth:function(n){return n.naturalWidth||n.width},getHeight:function(n){return n.naturalHeight||n.height}},pt=window.Promise?window.Promise:function(){var n=function(n){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof n)throw new TypeError("not a function");this._state=null,this._value=null,this._deferreds=[],s(n,t(r,this),t(u,this))},e=n.immediateFn||"function"==typeof window.setImmediate&&window.setImmediate||function(n){f.setTimeout(n,1)};function t(n,e){return function(){n.apply(e,arguments)}}var o=Array.isArray||function(n){return"[object Array]"===Object.prototype.toString.call(n)};function i(t){var o=this;null!==this._state?e(function(){var n=o._state?t.onFulfilled:t.onRejected;if(null!==n){var e;try{e=n(o._value)}catch(n){return void t.reject(n)}t.resolve(e)}else(o._state?t.resolve:t.reject)(o._value)}):this._deferreds.push(t)}function r(n){try{if(n===this)throw new TypeError("A promise cannot be resolved with itself.");if(n&&("object"==typeof n||"function"==typeof n)){var e=n.then;if("function"==typeof e)return void s(t(e,n),t(r,this),t(u,this))}this._state=!0,this._value=n,c.call(this)}catch(n){u.call(this,n)}}function u(n){this._state=!1,this._value=n,c.call(this)}function c(){for(var n=0,e=this._deferreds.length;n<e;n++)i.call(this,this._deferreds[n]);this._deferreds=null}function a(n,e,t,o){this.onFulfilled="function"==typeof n?n:null,this.onRejected="function"==typeof e?e:null,this.resolve=t,this.reject=o}function s(n,e,t){var o=!1;try{n(function(n){o||(o=!0,e(n))},function(n){o||(o=!0,t(n))})}catch(n){if(o)return;o=!0,t(n)}}return n.prototype.catch=function(n){return this.then(null,n)},n.prototype.then=function(t,o){var r=this;return new n(function(n,e){i.call(r,new a(t,o,n,e))})},n.all=function(){var c=Array.prototype.slice.call(1===arguments.length&&o(arguments[0])?arguments[0]:arguments);return new n(function(o,r){if(0===c.length)return o([]);var i=c.length;function u(e,n){try{if(n&&("object"==typeof n||"function"==typeof n)){var t=n.then;if("function"==typeof t)return void t.call(n,function(n){u(e,n)},r)}c[e]=n,0==--i&&o(c)}catch(n){r(n)}}for(var n=0;n<c.length;n++)u(n,c[n])})},n.resolve=function(e){return e&&"object"==typeof e&&e.constructor===n?e:new n(function(n){n(e)})},n.reject=function(t){return new n(function(n,e){e(t)})},n.race=function(r){return new n(function(n,e){for(var t=0,o=r.length;t<o;t++)r[t].then(n,e)})},n}();function _t(){return new(rn.getOrDie("FileReader"))}var yt={atob:function(n){return rn.getOrDie("atob")(n)},requestAnimationFrame:function(n){rn.getOrDie("requestAnimationFrame")(n)}};function wt(c){return new pt(function(n,e){var t=f.URL.createObjectURL(c),o=new f.Image,r=function(){o.removeEventListener("load",i),o.removeEventListener("error",u)};function i(){r(),n(o)}function u(){r(),e("Unable to load data of type "+c.type+": "+t)}o.addEventListener("load",i),o.addEventListener("error",u),o.src=t,o.complete&&i()})}function bt(o){return new pt(function(n,t){var e=new f.XMLHttpRequest;e.open("GET",o,!0),e.responseType="blob",e.onload=function(){200==this.status&&n(this.response)},e.onerror=function(){var n,e=this;t(0===this.status?((n=new Error("No access to download image")).code=18,n.name="SecurityError",n):new Error("Error "+e.status+" downloading image"))},e.send()})}function Ot(n){var e=n.split(","),t=/data:([^;]+)/.exec(e[0]);if(!t)return w.none();for(var o,r,i,u=t[1],c=e[1],a=yt.atob(c),s=a.length,f=Math.ceil(s/1024),d=new Array(f),l=0;l<f;++l){for(var m=1024*l,v=Math.min(m+1024,s),h=new Array(v-m),g=m,p=0;g<v;++p,++g)h[p]=a[g].charCodeAt(0);d[l]=(o=h,new(rn.getOrDie("Uint8Array"))(o))}return w.some((r=d,i={type:u},new(rn.getOrDie("Blob"))(r,i)))}function Ct(t){return new pt(function(n,e){Ot(t).fold(function(){e("uri is not base64: "+t)},n)})}function Et(t){return new pt(function(n){var e=_t();e.onloadend=function(){n(e.result)},e.readAsDataURL(t)})}var Dt,St,Tt,xt={blobToImage:wt,imageToBlob:function(n){var e=n.src;return 0===e.indexOf("data:")?Ct(e):bt(e)},blobToArrayBuffer:function(t){return new pt(function(n){var e=_t();e.onloadend=function(){n(e.result)},e.readAsArrayBuffer(t)})},blobToDataUri:Et,blobToBase64:function(n){return Et(n).then(function(n){return n.split(",")[1]})},dataUriToBlobSync:Ot,canvasToBlob:function(n,t,o){return t=t||"image/png",f.HTMLCanvasElement.prototype.toBlob?new pt(function(e){n.toBlob(function(n){e(n)},t,o)}):Ct(n.toDataURL(t,o))},canvasToDataURL:function(n,e,t){return e=e||"image/png",n.then(function(n){return n.toDataURL(e,t)})},blobToCanvas:function(n){return wt(n).then(function(n){var e,t;return e=n,f.URL.revokeObjectURL(e.src),t=ht.create(gt.getWidth(n),gt.getHeight(n)),ht.get2dContext(t).drawImage(n,0,0),t})},uriToBlob:function(n){return 0===n.indexOf("blob:")?bt(n):0===n.indexOf("data:")?Ct(n):null}},At=function(n){return xt.dataUriToBlobSync(n)},Nt=((Dt={})["2.0"]={encryptText:function(n){var e=new f.Blob([n],{type:"application/json"}),t=new f.FileReader;return Pe(function(n){t.addEventListener("loadend",function(){return n(Le.value({encrypted:[t.result]}))}),t.addEventListener("error",function(){return n(Le.error(t.error))}),t.readAsDataURL(e)})},decryptText:function(n){return At(n[0]).fold(function(){return He("Could not decode URI")},function(e){var t=new f.FileReader;return Pe(function(n){t.addEventListener("loadend",function(){return n(Le.value({decrypted:t.result}))}),t.addEventListener("error",function(){return n(Le.error(t.error.message))}),t.readAsText(e)})})}},Dt),kt=function(n){return V(e=Nt,t=n)?w.some(e[t]):w.none();var e,t},Mt=function(){return Nt["2.0"]},Rt="tinycomments",jt="2.0",Lt=function(n){return(e=n,dt.getOption(e)).map(function(n){return e=n.replace(/^\s+/g,""),t=e,r=0,""===(o=Rt)||!(t.length<o.length)&&t.substr(r,r+o.length)===o;var e,t,o,r}).isSome();var e},Ut=function(n){var e,t,o=(t=n,e=dt.get(t),e.replace(/^\s+|\s+$/g,"")).split("|");return 2<o.length?Le.value({version:o[1],rest:o.slice(2)}):Le.error("Embedded comments not in expected format.")},It=function(n){return(e=n,t=Lt,I(e.dom().childNodes,p(t,K.fromDom)).map(K.fromDom)).fold(function(){return Fe({conversations:{},commentTag:w.none(),encrypted:{encrypted:[]}})},function(i){return Ut(i).fold(He,function(n){var e,t,o=n.version,r=n.rest;return(e=o,t=r,kt(e).fold(function(){return He("No Encryptor for version: "+e)},function(n){return n.decryptText(t)})).bindResult(function(n){return function(n){try{var e=ft(n);return Le.value(e)}catch(n){return Le.error("Couldn not JSON parse conversations.")}}(n.decrypted).map(function(n){return{commentTag:w.some(i),conversations:n,encrypted:{encrypted:r}}})})})});var e,t},Bt=function(n){var e,t,o,r=K.fromDom(f.document.createComment([Rt,jt].concat(n.encrypted).join("|")));return e=r,t=K.fromTag("div"),o=K.fromDom(e.dom().cloneNode(!0)),Ln(t,o),t.dom().innerHTML},Pt=function(n){var r,t,e,o=Ze(n),u=(r={},t=w.none(),{get:function(){return ut(r,{})},clear:function(){r={},t=w.none()},addData:function(n,e){r[n]=e},setData:function(n,e){r=n,t=w.some(e)},setEncryptedData:function(n){t=w.some(n)},getEncrypedData:function(){return t},lookupData:e=function(n){return Object.prototype.hasOwnProperty.call(r,n)?w.some(r[n]):w.none()},removeData:function(n){delete r[n]},updateData:function(t,o){return e(t).map(function(n){var e=o(n);return r[t]=e})}}),i=nt(n),c=et(n),a=tt(n),s=Mt(),f=function(){return s.encryptText(JSON.stringify(u.get())).mapResult(function(n){return u.setEncryptedData(n)})},d=function(o,r,n,i){return(t=o,u.lookupData(t.conversationUid).fold(function(){return Le.error("Could not find conversation with uid "+t.conversationUid)},function(e){return I(e.comments,function(n){return n.uid===t.commentUid}).fold(function(){return Le.error("Could not find comment with uid "+t.commentUid+" in conversation "+t.conversationUid)},function(n){return Le.value({conversationUid:e.uid,comment:n})})})).fold(function(n){return He(n)},function(t){return n(t).bindFuture(function(n){var e;return!0!==n[r]?Fe(((e={})[r]=!1,e)):u.updateData(o.conversationUid,i(t)).fold(function(){return He("Could not operate on comment ("+r+")")},function(n){return f().mapResult(function(){var n;return(n={})[r]=!0,n})})})});var t};return{create:function(n){var e=T("mce-conversation");return u.addData(e,{uid:e,comments:[{uid:e,author:o,content:n.content,createdAt:n.createdAt,modifiedAt:n.createdAt}]}),f().mapResult(function(){return{conversationUid:e}})},reply:function(n){var e=T("mce-reply"),t={uid:e,author:o,content:n.content,createdAt:n.createdAt,modifiedAt:n.createdAt};return u.updateData(n.conversationUid,function(n){return Me({},n,{comments:n.comments.concat([t])})}).fold(function(){return He("Could not reply to uid: "+n.conversationUid)},function(){return f().mapResult(function(){return{commentUid:e}})})},lookup:function(n){return u.lookupData(n.conversationUid).fold(function(){return He("Could not find uid: "+n.conversationUid)},function(n){return Fe({conversation:n})})},deleteConversation:function(e){return u.lookupData(e.conversationUid).fold(function(){return He("Could not find conversation to delete")},function(n){return i({conversationUid:n.uid,comments:n.comments}).bindFuture(function(n){return n.canDelete?(u.removeData(e.conversationUid),f().mapResult(function(){return{canDelete:!0}})):Fe({canDelete:!1})})})},deleteAllConversations:function(n){var e=B(u.get()),o=j(e,function(n){return u.lookupData(n).fold(function(){return He("Could not find conversation")},function(n){return i({conversationUid:n.uid,comments:n.comments})})});return Pe(function(t){Qn(o).get(function(n){var e=function(n,e){for(var t=0,o=n.length;t<o;++t)if(!0!==e(n[t],t,n))return!1;return!0}(n,function(n){return n.exists(function(n){return n.canDelete})});e&&u.clear(),t(Le.value({canDelete:e}))})})},deleteComment:function(n){return d(n,"canDelete",c,function(n){return ct(n.comment.uid)})},editComment:function(e){return d(e,"canEdit",function(n){return a(Me({},n,{edit:{modifiedAt:e.modifiedAt,content:e.content}}))},function(n){return at(e.commentUid,e.content,e.modifiedAt)})},lifecycleHooks:{onSetContent:function(n){It(K.fromDom(n.getBody())).get(function(n){return n.fold(function(n){return console.error("Error extracting embedded conversations: "+n)},function(e){e.commentTag.each(function(n){u.setData(e.conversations,e.encrypted),In(n)})})})},onGetContent:function(n,e){return u.getEncrypedData().map(function(n){return e+Bt(n)})}}}},Ft=function(n,i,u){n.on("init",function(){n.annotator.register(_e(),{decorate:function(){return{classes:[he()],attributes:{}}}}),n.annotator.annotationChanged(_e(),function(n,e,t){if(n){u.onComment();var o=t.uid,r=t.nodes;i.refreshView(w.some({uid:o,nodes:j(r,K.fromDom)}))}else u.notOnComment(),i.refreshView(w.none())})})},Ht=function(n,e){var t,o,r=(t=e,null===(o=n.dom().getAttribute(t))?void 0:o);return void 0===r||""===r?[]:r.split(" ")},Vt=function(n){return void 0!==n.dom().classList},qt=function(n,e){return r=e,i=Ht(t=n,o="class").concat([r]),z(t,o,i.join(" ")),!0;var t,o,r,i},Yt=function(n,e){return r=e,0<(i=U(Ht(t=n,o="class"),function(n){return n!==r})).length?z(t,o,i.join(" ")):G(t,o),!1;var t,o,r,i},Wt=function(n){0===(Vt(n)?n.dom().classList:Ht(n,"class")).length&&G(n,"class")},Xt=function(e){return(n=Rn(e),t=void 0!==n?n.dom():f.document,w.from(t.activeElement).map(K.fromDom)).filter(function(n){return e.dom().contains(n.dom())});var n,t},zt=function(o,r){return function(n){var e,t;r.set(St.Open),e=K.fromDom(o.getBody()),t=ye(),Vt(e)?e.dom().classList.add(t):qt(e,t),o.fire("mce-tinycomments-update",{}),Ae(o,!1)}},Gt=function(o,r){return function(n){var e,t;Xt(K.fromDom(n.element())).each(function(n){o.focus()}),r.set(St.Closed),e=K.fromDom(o.getBody()),t=ye(),Vt(e)?e.dom().classList.remove(t):Yt(e,t),Wt(e),o.fire("mce-tinycomments-update",{})}},Jt=function(n,e){n===h.Modern?e.getContainer().querySelector(".mce-sidebar-toolbar .mce-i-conversation").click():ke(e,"showcomments")},$t=function(n,e,t){t.get()!==St.Closed&&t.get()!==St.Closing||Jt(n,e),Ae(e,!0)},Kt=function(t,e,o){t.ui.registry.addButton("addcomment",{tooltip:Vn.tc_items_addcomment,shortcut:"meta+Alt+M",icon:"comment",onAction:function(){$t(h.Silver,t,o)}}),t.ui.registry.addMenuItem("addcomment",{text:Vn.tc_items_addcomment,shortcut:"meta+Alt+M",onAction:function(){$t(h.Silver,t,o)}}),t.ui.registry.addMenuItem("deleteallconversations",{text:Vn.tc_items_deleteall,onAction:function(){Ne(t)}}),t.ui.registry.addToggleMenuItem("showcomments",{text:Vn.tc_items_showcomments,onAction:function(){Jt(h.Silver,t)},onSetup:function(n){var e=function(){n.setActive(o.get()===St.Open)};return t.on("mce-tinycomments-update",e),e(),function(){t.off("mce-tinycomments-update",e)}}}),t.ui.registry.addSidebar("showcomments",{tooltip:Vn.tc_items_showcomments,icon:"comment",onSetup:function(n){return e.rememberSidebar(K.fromDom(n.element())),function(){}},onShow:zt(t,o),onHide:Gt(t,o)})},Qt=function(t,e,o){t.addButton("showcomments",{icon:"bubble",tooltip:Vn.tc_items_showcomments,onclick:function(){Jt(h.Modern,t)},onPostRender:function(e){t.on("mce-tinycomments-update",function(n){e.control.active(o.get()===St.Open)})}}),t.addButton("addcomment",{tooltip:Vn.tc_items_addcomment,icon:"bubble",onclick:function(n){$t(h.Modern,t,o)}}),t.addMenuItem("showcomments",{text:Vn.tc_items_showcomments,context:"view",selectable:!0,onclick:function(n){Jt(h.Modern,t)},onPostRender:function(e){t.on("mce-tinycomments-update",function(n){e.control.active(o.get()===St.Open)})}}),t.addMenuItem("addcomment",{text:Vn.tc_items_addcomment,context:"insert",onclick:function(n){$t(h.Modern,t,o)}}),t.addMenuItem("deleteallconversations",{text:Vn.tc_items_deleteall,context:"file",onclick:function(n){Ne(t)}}),t.addSidebar("showcomments",{tooltip:Vn.tc_items_showcomments,icon:"conversation",onrender:function(n){e.rememberSidebar(K.fromDom(n.element()))},onshow:zt(t,o),onhide:Gt(t,o)})};(Tt=St||(St={}))[Tt.Open=0]="Open",Tt[Tt.Closed=1]="Closed",Tt[Tt.Closing=2]="Closing";var Zt=function(n,e,t){var o=g(St.Closed);e.shortcuts.add("meta+alt+m","TinyComments addComment",function(){$t(n,e,o)}),(n===h.Modern?Qt:Kt)(e,t,o)},no=function(i,u){var n,o,t,e,r,c,a=g(!1),s=g(w.none()),f=D(tinymce,"5.0.0")?h.Modern:h.Silver,d=("embedded"===ot(n=i)?Pt:rt)(n),l=(o=g(w.none()),t=g(w.none()),{rememberSidebar:function(e){t.set(w.some(e)),o.get().fold(function(){var n=K.fromHtml('<div aria-busy="true" class="tox-conversations" style="position: relative;">\n  <div class="tox-dialog__busy-spinner">\n  <div class="tox-loading-text">\n      <div>\n      <p>Comments are loading</p>\n      </div>\n  <div class="tox-spinner">\n      <div></div>\n      <div></div>\n      <div></div>\n  </div>\n</div></div>');Ln(e,n)},function(n){n.attachTo(e)})},setUi:function(e){o.set(w.some(e)),t.get().each(function(n){Un(n),e.attachTo(n)})},refreshView:function(e){o.get().fold(function(){},function(n){n.controller.refreshView(e)})},refreshSidebar:function(e,t){o.get().fold(function(){},function(n){n.controller.refreshSidebar(e,t)})},showError:function(e,t){o.get().each(function(n){return n.controller.showError(e,t)})}}),m={translate:tinymce.translate};ce([{type:"js",filename:(e=i,r=u,c=e.settings.tinycomments_js_url,(c?c+"/":r+"/js/")+"tinycomments-sidebar.min.js")}]).get(function(n){return n(f,i,d,s,function(n){l.setUi(n),l.refreshSidebar(s.get(),5),a.set(!0)},m)});var v=Yn(m);return xe(i,l,d,s),Ft(i,l,v),Zt(f,i,l),i.on("init",function(){var n,e,t,o,r;n=f,t=u,o=(e=i).settings.tinycomments_css_url,r=o?o+"/":t+"/css/",tinymce.DOM.styleSheetLoader.load(r+"tinycomments.css",function(){}),n===h.Modern&&(tinymce.DOM.styleSheetLoader.load(r+"tinycomments-tinymce4.css",function(){}),tinymce.DOM.styleSheetLoader.load(r+"tinymce4-icons.css",function(){}),e.dom.loadCSS(r+"tinymce4-content.css")),l.refreshSidebar(w.none(),5)}),i.on("setContent",function(n){n.selection||(d.lifecycleHooks.onSetContent(i),l.refreshView(w.none()))}),i.on("getContent",function(n){var e=!0===n.source_view,t=!0===n.contextual,o=e||t?w.none():d.lifecycleHooks.onGetContent(i,n.content);n.content=o.getOr(n.content)}),{hasLoadedUi:function(){return a.get()}}},eo=function(n,e){return D(tinymce,"4.8.0")?(Xn.error("The tinycomments plugin requires at least 4.8.0 version of TinyMCE."),{}):no(n,e)};return tinymce.PluginManager.add("tinycomments",eo),function(){tinymce.PluginManager.get("tinycomments")||tinymce.PluginManager.add("tinycomments",eo)}}(window)();